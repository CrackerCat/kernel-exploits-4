#!/bin/sh

gcc ./exploit.c -o exploit -static -lpthread
cp exploit ./initramfs
gcc ./exploit-no-kaslr.c -o exploit-no-kaslr -static -lpthread
cp exploit-no-kaslr ./initramfs

cd ./initramfs
find . | cpio -o -H newc | gzip > ../initramfs.cpio.gz
cd ../

qemu-system-x86_64 \
    -m 128M \
    -cpu kvm64,+smep,+smap \
    -kernel vmlinuz \
    -initrd initramfs.cpio.gz \
    -hdb flag.txt \
    -snapshot \
    -nographic \
    -monitor /dev/null \
    -no-reboot \
    -append "console=ttyS0 kaslr kpti=1 quiet panic=1" \
    -s

